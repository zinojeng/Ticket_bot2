# ğŸš„ Ticket-Bot é–‹ç™¼è¨­è¨ˆæ–‡æª”

> æœ¬æ–‡ä»¶è¨˜éŒ„äº† Ticket-Bot å°ˆæ¡ˆçš„æ‰€æœ‰è¨­è¨ˆæ¦‚å¿µã€æ¶æ§‹æ±ºç­–èˆ‡å¯¦ä½œç´°ç¯€ã€‚
> 
> æœ€å¾Œæ›´æ–°ï¼š2026-01-19

---

## ç›®éŒ„

1. [å°ˆæ¡ˆæ¦‚è¿°](#å°ˆæ¡ˆæ¦‚è¿°)
2. [ç’°å¢ƒè¨­å®š](#ç’°å¢ƒè¨­å®š)
3. [é©—è­‰ç¢¼è­˜åˆ¥ç­–ç•¥](#é©—è­‰ç¢¼è­˜åˆ¥ç­–ç•¥)
4. [å¤šè¨­å®šæª”æ”¯æ´](#å¤šè¨­å®šæª”æ”¯æ´)
5. [æ™‚é–“å€é–“ç¯©é¸](#æ™‚é–“å€é–“ç¯©é¸)
6. [è¨‚ç¥¨æˆåŠŸè‡ªå‹•åœæ­¢](#è¨‚ç¥¨æˆåŠŸè‡ªå‹•åœæ­¢)
7. [æˆåŠŸå¾Œå†å¾ªç’°æ¬¡æ•¸](#æˆåŠŸå¾Œå†å¾ªç’°æ¬¡æ•¸)
8. [è…³æœ¬åŸ·è¡Œæµç¨‹](#è…³æœ¬åŸ·è¡Œæµç¨‹)
9. [è¨­å®šæª”æ¬„ä½èªªæ˜](#è¨­å®šæª”æ¬„ä½èªªæ˜)

---

## å°ˆæ¡ˆæ¦‚è¿°

Ticket-Bot æ˜¯ä¸€å€‹è‡ªå‹•åŒ–å°ç£é«˜éµï¼ˆTHSRCï¼‰è¨‚ç¥¨å·¥å…·ï¼Œé€éè‡ªå‹•åŒ–æµç¨‹å®Œæˆï¼š

1. **é€£ç·šé«˜éµç¶²ç«™** â†’ å–å¾— Session ID å’Œé©—è­‰ç¢¼
2. **é©—è­‰ç¢¼è­˜åˆ¥** â†’ ä½¿ç”¨é›™é‡ OCR ç­–ç•¥æé«˜æº–ç¢ºç‡
3. **æŸ¥è©¢è»Šæ¬¡** â†’ æ ¹æ“šè¨­å®šçš„æ™‚é–“å€é–“ç¯©é¸ç­æ¬¡
4. **è‡ªå‹•é¸æ“‡** â†’ é¸æ“‡æœ€çŸ­è»Šç¨‹æˆ–å„ªæƒ è»Šæ¬¡
5. **å®Œæˆè¨‚ç¥¨** â†’ å¡«å¯«ä¹˜å®¢è³‡æ–™ä¸¦æäº¤

---

## ç’°å¢ƒè¨­å®š

### å•é¡ŒèƒŒæ™¯

macOS ä½¿ç”¨ Homebrew å®‰è£çš„ Python æœƒé‡åˆ° `externally-managed-environment` éŒ¯èª¤ï¼ˆPEP 668ï¼‰ï¼Œé˜»æ­¢ç›´æ¥ä½¿ç”¨ `pip install` å®‰è£ç³»çµ±å±¤ç´šçš„å¥—ä»¶ã€‚

### è§£æ±ºæ–¹æ¡ˆï¼šè™›æ“¬ç’°å¢ƒ

ä½¿ç”¨ Python è™›æ“¬ç’°å¢ƒ (`venv`) éš”é›¢å°ˆæ¡ˆä¾è³´ï¼š

```bash
# å»ºç«‹è™›æ“¬ç’°å¢ƒ
python3 -m venv venv

# å•Ÿç”¨è™›æ“¬ç’°å¢ƒ
source venv/bin/activate

# å®‰è£ä¾è³´ï¼ˆåœ¨è™›æ“¬ç’°å¢ƒä¸­ï¼‰
pip install -r requirements.txt
```

### script.sh å¯¦ä½œ

```bash
# å»ºç«‹è™›æ“¬ç’°å¢ƒï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
if [ ! -d "venv" ]; then
    echo "Creating virtual environment..."
    python3 -m venv venv
fi

# å•Ÿç”¨è™›æ“¬ç’°å¢ƒ
source venv/bin/activate

# ä½¿ç”¨è™›æ“¬ç’°å¢ƒä¸­çš„ pip å’Œ python
venv/bin/pip install -r requirements.txt
venv/bin/python ticket_bot.py thsrc -a
```

### .env ç’°å¢ƒè®Šæ•¸

API é‡‘é‘°é€é `.env` æª”æ¡ˆç®¡ç†ï¼š

```bash
# .env æª”æ¡ˆå…§å®¹
GEMINI_API_KEY=your_api_key_here
```

è¼‰å…¥æ–¹å¼ï¼ˆshell scriptï¼‰ï¼š

```bash
if [ -f ".env" ]; then
    export $(grep -v '^#' .env | xargs)
fi
```

è¼‰å…¥æ–¹å¼ï¼ˆPythonï¼‰ï¼š

```python
from dotenv import load_dotenv
import pathlib

env_path = pathlib.Path(__file__).parent / '.env'
load_dotenv(dotenv_path=env_path, override=True)  # override=True å¼·åˆ¶è¦†è“‹ç³»çµ±ç’°å¢ƒè®Šæ•¸
```

---

## é©—è­‰ç¢¼è­˜åˆ¥ç­–ç•¥

### è¨­è¨ˆç†å¿µ

é«˜éµé©—è­‰ç¢¼è­˜åˆ¥æ˜¯è¨‚ç¥¨æˆåŠŸçš„é—œéµã€‚æˆ‘å€‘æ¡ç”¨ **é›™é‡ OCR + ä»²è£æ©Ÿåˆ¶** ä¾†æœ€å¤§åŒ–è­˜åˆ¥æº–ç¢ºç‡ã€‚

### ä¸‰å±¤è­˜åˆ¥æ¶æ§‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        é©—è­‰ç¢¼åœ–ç‰‡                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â–¼                               â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚   holey.cc OCR   â”‚            â”‚   Gemini 3 Flash â”‚
    â”‚  (å°ˆé–€è¨“ç·´æ¨¡å‹)   â”‚            â”‚   (AI è¦–è¦ºæ¨¡å‹)   â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚                               â”‚
              â”‚         çµæœ A                â”‚         çµæœ B
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚     æ¯”å°çµæœ     â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â–¼                               â–¼
        çµæœä¸€è‡´                          çµæœä¸ä¸€è‡´
              â”‚                               â”‚
              â–¼                               â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚    ç›´æ¥ä½¿ç”¨      â”‚            â”‚   ä»²è£åˆ¤æ–·       â”‚
    â”‚   ï¼ˆä¿¡å¿ƒåº¦é«˜ï¼‰    â”‚            â”‚  (Gemini 3 å†åˆ¤) â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### holey.cc OCR

å°ˆé–€ç‚ºå°ç£é«˜éµé©—è­‰ç¢¼è¨“ç·´çš„ OCR æ¨¡å‹ï¼š

```python
base64_url_safe = base64_str.replace('+', '-').replace('/', '_').replace('=', '')
data = {'base64_str': base64_url_safe}
ocr_res = httpx.post('https://holey.cc/api/captcha', json=data)
holey_result = ocr_res.json().get('data')  # e.g., "A2B3"
```

### Gemini 3 Flash

Google çš„ AI è¦–è¦ºæ¨¡å‹ï¼Œç”¨æ–¼ç¨ç«‹è­˜åˆ¥å’Œä»²è£ï¼š

```python
api_url = f"https://generativelanguage.googleapis.com/v1beta/models/gemini-3-flash-preview:generateContent?key={api_key}"

prompt = "Read the 4 characters in this CAPTCHA image. Output EXACTLY 4 characters (A-Z, 0-9) ONLY."

payload = {
    "contents": [{
        "parts": [
            {"text": prompt},
            {"inline_data": {"mime_type": "image/png", "data": base64_image}}
        ]
    }],
    "generationConfig": {
        "maxOutputTokens": 256,  # Gemini 3 æ˜¯æ€è€ƒæ¨¡å‹ï¼Œéœ€è¦æ›´å¤š token
        "temperature": 0.1,
        "topP": 0.1
    }
}
```

### ä»²è£æ©Ÿåˆ¶

ç•¶å…©å€‹è­˜åˆ¥çµæœä¸ä¸€è‡´æ™‚ï¼Œè®“ Gemini 3 ä½œç‚ºã€Œä»²è£è€…ã€åšæœ€çµ‚åˆ¤æ–·ï¼š

```python
def _ocr_arbitrate_with_gemini(self, base64_image, result_a, result_b, api_key):
    prompt = f"""This CAPTCHA image has been recognized by two different OCR systems:
- System A (specialized OCR): {result_a}
- System B (AI vision): {result_b}

Look at the image carefully and determine which result is CORRECT.

IMPORTANT:
- Characters that often get confused: 0/O, 1/I, 5/S, 8/B, 2/Z, 6/G, 9/P

Output ONLY the correct 4-character code. No explanation."""
```

### æ±ºç­–é‚è¼¯

```python
if holey_result.upper() == gemini_result.upper():
    # å…©è€…ä¸€è‡´ â†’ ç›´æ¥ä½¿ç”¨
    return gemini_result
else:
    # ä¸ä¸€è‡´ â†’ å•Ÿå‹•ä»²è£
    final_result = self._ocr_arbitrate_with_gemini(...)
    if final_result:
        return final_result
    else:
        # ä»²è£å¤±æ•— â†’ å„ªå…ˆä½¿ç”¨ holey.ccï¼ˆå°ˆé–€è¨“ç·´ï¼‰
        return holey_result
```

---

## å¤šè¨­å®šæª”æ”¯æ´

### ä½¿ç”¨å ´æ™¯

éœ€è¦åŒæ™‚é‹è¡Œå¤šå€‹ä¸åŒè¨­å®šçš„è¨‚ç¥¨ä»»å‹™ï¼Œä¾‹å¦‚ï¼š
- ä¸åŒæ—¥æœŸ
- ä¸åŒå‡ºç™¼/æŠµé”ç«™
- ä¸åŒæ™‚é–“å€é–“

### å¯¦ä½œæ–¹å¼

#### 1. å‘½ä»¤åˆ—åƒæ•¸

```bash
# ä½¿ç”¨é è¨­è¨­å®šæª” (user_config.toml)
python ticket_bot.py thsrc -a

# ä½¿ç”¨è‡ªè¨‚è¨­å®šæª”
python ticket_bot.py thsrc -a -c user_config2.toml
```

#### 2. ticket_bot.py æ”¯æ´

```python
parser.add_argument(
    '-c', '--config',
    dest='config_file',
    help="path to custom config file",
)

if args.config_file:
    config_path = Path(args.config_file)
    if not config_path.is_absolute():
        config_path = Path(os.path.dirname(__file__)) / config_path
    config = Config.from_toml(config_path)
```

#### 3. ç¨ç«‹è…³æœ¬

- `script.sh` â†’ ä½¿ç”¨ `user_config.toml`
- `script2.sh` â†’ ä½¿ç”¨ `user_config2.toml`

å¯ä»¥åŒæ™‚åœ¨å…©å€‹çµ‚ç«¯æ©Ÿè¦–çª—ä¸­é‹è¡Œä¸åŒè¨­å®šçš„è¨‚ç¥¨ä»»å‹™ã€‚

---

## æ™‚é–“å€é–“ç¯©é¸

### è¨­è¨ˆç›®çš„

åŸæœ¬åªèƒ½è¨­å®šã€Œå‡ºç™¼æ™‚é–“èµ·é»ã€ï¼Œç¾åœ¨å¯ä»¥è¨­å®šå®Œæ•´çš„æ™‚é–“å€é–“ï¼Œä¾‹å¦‚åªæœå°‹ 12:30 ~ 13:00 ä¹‹é–“çš„ç­æ¬¡ã€‚

### è¨­å®šæ¬„ä½

```toml
[fields.THSRC]
outbound-time = '12:30'      # å‡ºç™¼æ™‚é–“ï¼ˆæœå°‹èµ·å§‹æ™‚é–“ï¼‰
outbound-time-end = '13:00'  # å‡ºç™¼æ™‚é–“çµæŸï¼ˆæœå°‹çµæŸæ™‚é–“ï¼Œç•™ç©ºå‰‡ä¸é™åˆ¶ï¼‰
inbound-time = ''            # æŠµé”æ™‚é–“é™åˆ¶ï¼ˆé¸å¡«ï¼‰
```

### å¯¦ä½œé‚è¼¯

```python
def confirm_train(self, html_page, default_value: int = 1):
    trains = []
    outbound_time_end = self.fields.get('outbound-time-end', '')
    
    for train in html_page.find_all('input', {...}):
        departure_time = train['querydeparture']
        
        # éæ¿¾å‡ºç™¼æ™‚é–“çµæŸ
        if outbound_time_end:
            if datetime.strptime(departure_time, '%H:%M').time() > \
               datetime.strptime(outbound_time_end, '%H:%M').time():
                continue  # è·³éè¶…éçµæŸæ™‚é–“çš„ç­æ¬¡
        
        trains.append({...})
```

### è‡ªå‹•é¸æ“‡é‚è¼¯

åœ¨æŒ‡å®šæ™‚é–“å€é–“å…§ï¼Œè‡ªå‹•é¸æ“‡ï¼š
1. **å„ªæƒ ç­æ¬¡** â†’ æœ‰æŠ˜æ‰£çš„å„ªå…ˆ
2. **æœ€çŸ­è»Šç¨‹** â†’ åœ¨ç¬¦åˆæ¢ä»¶çš„ç­æ¬¡ä¸­é¸æ“‡è»Šç¨‹æœ€çŸ­çš„

```python
if self.auto:
    # å„ªå…ˆé¸æ“‡æœ‰æŠ˜æ‰£çš„ç­æ¬¡
    if has_discount:
        trains = list(filter(lambda t: t['discount'], trains)) or trains
    
    # é¸æ“‡æœ€çŸ­è»Šç¨‹
    trains = [min(trains, key=lambda t: datetime.strptime(t['duration'], '%H:%M').time())]
```

---

## è¨‚ç¥¨æˆåŠŸè‡ªå‹•åœæ­¢

### å•é¡Œæè¿°

åŸæœ¬çš„ `while true` ç„¡é™å¾ªç’°æœƒåœ¨è¨‚ç¥¨æˆåŠŸå¾Œç¹¼çºŒåŸ·è¡Œï¼Œå°è‡´ï¼š
1. ä¸å¿…è¦çš„é‡è¤‡è¨‚ç¥¨
2. æˆåŠŸç•«é¢è¢« `clear` æ¸…é™¤

### è§£æ±ºæ–¹æ¡ˆ

#### Python ç«¯ï¼šæˆåŠŸå¾Œ exit(0)

```python
def print_result(self, html_page):
    # ... å°å‡ºè¨‚ç¥¨çµæœ ...
    
    # è¨‚ç¥¨æˆåŠŸï¼Œè‡ªå‹•åœæ­¢ç¨‹å¼
    self.logger.info("\nğŸ‰ è¨‚ç¥¨æˆåŠŸï¼ç¨‹å¼è‡ªå‹•åœæ­¢ã€‚")
    sys.exit(0)  # æˆåŠŸé€€å‡ºç¢¼
```

#### Shell ç«¯ï¼šæª¢æŸ¥ exit code

```bash
while true
do
    venv/bin/python ticket_bot.py thsrc -a
    EXIT_CODE=$?
    
    if [ $EXIT_CODE -eq 0 ]; then
        echo "ğŸ‰ğŸ‰ğŸ‰ è¨‚ç¥¨æˆåŠŸï¼ç¨‹å¼å·²åœæ­¢ã€‚ğŸ‰ğŸ‰ğŸ‰"
        afplay /System/Library/Sounds/Glass.aiff  # æ’­æ”¾æç¤ºéŸ³
        break  # åœæ­¢å¾ªç’°
    fi
    
    # å¤±æ•—æ‰é‡è©¦
    sleep 5
    clear
done
```

---

## æˆåŠŸå¾Œå†å¾ªç’°æ¬¡æ•¸

### è¨­è¨ˆç›®çš„

æœ‰æ™‚å€™éœ€è¦é è¨‚å¤šå¼µç¥¨ï¼ˆä¾‹å¦‚å®¶äººåˆ†é–‹è¨‚ï¼‰ï¼Œå¯ä»¥è¨­å®šæˆåŠŸå¾Œé‚„è¦å†å˜—è©¦å¹¾æ¬¡ã€‚

### è¨­å®šæ¬„ä½

```toml
[schedules.THSRC]
datetime = ''
success-repeat = 0  # æˆåŠŸå¾Œå†å¾ªç’°æ¬¡æ•¸ï¼ˆ0 = æˆåŠŸå¾Œç«‹å³åœæ­¢ï¼Œ3 = æˆåŠŸå¾Œå†å˜—è©¦3æ¬¡ï¼‰
```

### è¨­å®šèªªæ˜

| è¨­å®šå€¼ | è¡Œç‚º | ç¸½æˆåŠŸæ¬¡æ•¸ |
|--------|------|-----------|
| `success-repeat = 0` | æˆåŠŸ 1 æ¬¡å¾Œç«‹å³åœæ­¢ | 1 æ¬¡ |
| `success-repeat = 1` | æˆåŠŸå¾Œå†å˜—è©¦ 1 æ¬¡ | æœ€å¤š 2 æ¬¡ |
| `success-repeat = 3` | æˆåŠŸå¾Œå†å˜—è©¦ 3 æ¬¡ | æœ€å¤š 4 æ¬¡ |

### Shell å¯¦ä½œ

```bash
# å¾è¨­å®šæª”è®€å– success-repeat
SUCCESS_REPEAT=$(grep -E "^success-repeat\s*=" "$CONFIG_FILE" | sed "s/.*=\s*\([0-9]*\).*/\1/")
SUCCESS_REPEAT=${SUCCESS_REPEAT:-0}

# æˆåŠŸè¨ˆæ•¸å™¨
SUCCESS_COUNT=0
TOTAL_SUCCESS_NEEDED=$((SUCCESS_REPEAT + 1))

while true
do
    venv/bin/python ticket_bot.py thsrc -a
    EXIT_CODE=$?
    
    if [ $EXIT_CODE -eq 0 ]; then
        SUCCESS_COUNT=$((SUCCESS_COUNT + 1))
        echo "ğŸ‰ è¨‚ç¥¨æˆåŠŸï¼(ç¬¬ $SUCCESS_COUNT æ¬¡æˆåŠŸï¼Œå…±éœ€ $TOTAL_SUCCESS_NEEDED æ¬¡)"
        afplay /System/Library/Sounds/Glass.aiff
        
        if [ $SUCCESS_COUNT -ge $TOTAL_SUCCESS_NEEDED ]; then
            echo "ğŸ‰ğŸ‰ğŸ‰ å·²å®Œæˆ $SUCCESS_COUNT æ¬¡æˆåŠŸè¨‚ç¥¨ï¼ç¨‹å¼åœæ­¢ã€‚ğŸ‰ğŸ‰ğŸ‰"
            break
        else
            REMAINING=$((TOTAL_SUCCESS_NEEDED - SUCCESS_COUNT))
            echo "â³ é‚„éœ€è¦æˆåŠŸ $REMAINING æ¬¡ï¼Œ10ç§’å¾Œç¹¼çºŒ..."
            sleep 10
        fi
    else
        echo "âš ï¸ ç¨‹å¼ç•°å¸¸é€€å‡ºï¼Œ5ç§’å¾Œé‡è©¦..."
        sleep 5
        clear
    fi
done
```

---

## è…³æœ¬åŸ·è¡Œæµç¨‹

### script.sh å®Œæ•´æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        script.sh å•Ÿå‹•                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   è¼‰å…¥ .env      â”‚
                    â”‚  (API é‡‘é‘°)      â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ è®€å– success-    â”‚
                    â”‚ repeat è¨­å®š      â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ å»ºç«‹/å•Ÿç”¨ venv   â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ å®‰è£ requirementsâ”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚            while true å¾ªç’°           â”‚
          â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
          â”‚  â”‚     åŸ·è¡Œ ticket_bot.py         â”‚  â”‚
          â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
          â”‚                   â”‚                  â”‚
          â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
          â”‚     â–¼             â–¼             â–¼    â”‚
          â”‚  exit=0       exit=1       å…¶ä»–      â”‚
          â”‚  (æˆåŠŸ)       (å¤±æ•—)       (éŒ¯èª¤)    â”‚
          â”‚     â”‚             â”‚             â”‚    â”‚
          â”‚     â–¼             â”‚             â”‚    â”‚
          â”‚  SUCCESS_COUNT++  â”‚             â”‚    â”‚
          â”‚  æ’­æ”¾æç¤ºéŸ³       â”‚             â”‚    â”‚
          â”‚     â”‚             â”‚             â”‚    â”‚
          â”‚     â–¼             â”‚             â”‚    â”‚
          â”‚  é”åˆ°ç›®æ¨™æ¬¡æ•¸ï¼Ÿ    â”‚             â”‚    â”‚
          â”‚  â”Œâ”€â”€â”€â”´â”€â”€â”€â”        â”‚             â”‚    â”‚
          â”‚  â–¼       â–¼        â–¼             â–¼    â”‚
          â”‚ Yes     No     5ç§’å¾Œé‡è©¦  5ç§’å¾Œé‡è©¦  â”‚
          â”‚  â”‚       â”‚        â”‚             â”‚    â”‚
          â”‚  â–¼       â”‚        â”‚             â”‚    â”‚
          â”‚ break    â”‚        â”‚             â”‚    â”‚
          â”‚          â””â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   ç¨‹å¼çµæŸ       â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## è¨­å®šæª”æ¬„ä½èªªæ˜

### user_config.toml å®Œæ•´çµæ§‹

```toml
# =====================================================
# æ’ç¨‹è¨­å®š
# =====================================================
[schedules]

[schedules.THSRC]
datetime = ''           # é è¨ˆè¨‚ç¥¨æ™‚é–“ (e.g. 2026-01-20 00:00)
success-repeat = 0      # æˆåŠŸå¾Œå†å¾ªç’°æ¬¡æ•¸

# =====================================================
# HTTP æ¨™é ­
# =====================================================
[headers]
User-Agent = 'Mozilla/5.0 ...'  # å¾ç€è¦½å™¨è¤‡è£½

# =====================================================
# ç›®éŒ„è¨­å®š
# =====================================================
[directories]
# logs = 'logs/'  # å¯è‡ªè¨‚æ—¥èªŒç›®éŒ„

# =====================================================
# è¨‚ç¥¨æ¬„ä½è¨­å®š
# =====================================================
[fields]

[fields.THSRC]
id = 'A123456789'         # èº«åˆ†è­‰å­—è™Ÿ
start-station = 'Taipei'  # å‡ºç™¼ç«™
dest-station = 'Taichung' # æŠµé”ç«™
outbound-date = '2026-01-20'  # å‡ºç™¼æ—¥æœŸ
outbound-time = '12:00'       # å‡ºç™¼æ™‚é–“ï¼ˆæœå°‹èµ·å§‹ï¼‰
outbound-time-end = '13:00'   # å‡ºç™¼æ™‚é–“çµæŸï¼ˆç•™ç©ºä¸é™åˆ¶ï¼‰
inbound-time = ''             # æŠµé”æ™‚é–“é™åˆ¶ï¼ˆç•™ç©ºä¸é™åˆ¶ï¼‰
preferred-seat = ''           # åº§ä½åå¥½ (window/aisle)
car-type = 'normal'           # è»Šå»‚é¡å‹ (normal/business)
train-no = ''                 # æŒ‡å®šè»Šæ¬¡ï¼ˆç•™ç©ºå‰‡æ™‚é–“æœå°‹ï¼‰
email = 'user@example.com'    # é€šçŸ¥ä¿¡ç®±
phone = '0912345678'          # æ‰‹æ©Ÿè™Ÿç¢¼
tgo-id = ''                   # TGO æœƒå“¡ ID
tax-id = ''                   # çµ±ä¸€ç·¨è™Ÿï¼ˆå…¬å¸å ±å¸³ï¼‰

# =====================================================
# ç¥¨ç¨®æ•¸é‡
# =====================================================
[fields.THSRC.ticket]
adult = 1     # å…¨ç¥¨
child = 0     # å­©ç«¥ç¥¨ (6-11)
disabled = 0  # æ„›å¿ƒç¥¨
elder = 0     # æ•¬è€ç¥¨ (65+)
college = 0   # å¤§å­¸ç”Ÿç¥¨
teenager = 0  # å°‘å¹´ç¥¨ (12-18)

# =====================================================
# ç‰¹æ®Šç¥¨ç¨®èº«åˆ†è­‰
# =====================================================
[fields.THSRC.ids]
disabled = []                       # æ„›å¿ƒç¥¨èº«åˆ†è­‰
elder = ['A270002017', 'B123456789']  # æ•¬è€ç¥¨èº«åˆ†è­‰

# =====================================================
# ä»£ç†ä¼ºæœå™¨è¨­å®š
# =====================================================
[proxies]
# us = 'http://127.0.0.1:7890'

# =====================================================
# NordVPN è¨­å®š
# =====================================================
[nordvpn]
username = ''
password = ''
```

---

## è»Šç«™ä»£ç¢¼å°ç…§è¡¨

| ä¸­æ–‡åç¨± | è‹±æ–‡åç¨± | ä»£ç¢¼ |
|----------|----------|------|
| å—æ¸¯ | Nangang | 1 |
| å°åŒ— | Taipei | 2 |
| æ¿æ©‹ | Banqiao | 3 |
| æ¡ƒåœ’ | Taoyuan | 4 |
| æ–°ç«¹ | Hsinchu | 5 |
| è‹—æ — | Miaoli | 6 |
| å°ä¸­ | Taichung | 7 |
| å½°åŒ– | Changhua | 8 |
| é›²æ— | Yunlin | 9 |
| å˜‰ç¾© | Chiayi | 10 |
| å°å— | Tainan | 11 |
| å·¦ç‡Ÿ | Zuouing | 12 |

---

## å¸¸è¦‹å•é¡Œæ’è§£

### 1. externally-managed-environment éŒ¯èª¤

```
error: externally-managed-environment
```

**è§£æ±º**ï¼šä½¿ç”¨è™›æ“¬ç’°å¢ƒï¼ˆåƒè¦‹ [ç’°å¢ƒè¨­å®š](#ç’°å¢ƒè¨­å®š)ï¼‰

### 2. GEMINI_API_KEY æœªè®€å–

**åŸå› **ï¼šç³»çµ±ç’°å¢ƒè®Šæ•¸è¦†è“‹ `.env` æª”æ¡ˆ

**è§£æ±º**ï¼šä½¿ç”¨ `override=True`

```python
load_dotenv(dotenv_path=env_path, override=True)
```

### 3. é©—è­‰ç¢¼ä¸€ç›´éŒ¯èª¤

**å¯èƒ½åŸå› **ï¼š
- holey.cc æœå‹™ä¸ç©©å®š
- Gemini API é‡‘é‘°ç„¡æ•ˆ
- ç¶²è·¯é€£ç·šå•é¡Œ

**è§£æ±º**ï¼š
- æª¢æŸ¥ `.env` ä¸­çš„ `GEMINI_API_KEY`
- ç¢ºèªç¶²è·¯é€£ç·šæ­£å¸¸
- æŸ¥çœ‹ logs ä¸­çš„éŒ¯èª¤è¨Šæ¯

### 4. æ‰¾ä¸åˆ°ç¬¦åˆæ¢ä»¶çš„ç­æ¬¡

**å¯èƒ½åŸå› **ï¼š
- `outbound-time-end` è¨­å®šçš„å€é–“å¤ªçª„
- è©²æ™‚æ®µæ²’æœ‰ç­æ¬¡

**è§£æ±º**ï¼šæ“´å¤§æ™‚é–“å€é–“æˆ–ç§»é™¤ `outbound-time-end` è¨­å®š

---

## ç‰ˆæœ¬æ­·å²

| ç‰ˆæœ¬ | æ—¥æœŸ | æ›´æ–°å…§å®¹ |
|------|------|----------|
| v1.0 | 2026-01-19 | åˆå§‹ç‰ˆæœ¬ï¼šé›™é‡ OCRã€æ™‚é–“å€é–“ã€æˆåŠŸåœæ­¢ã€å†å¾ªç’°æ¬¡æ•¸ |

---

## è²¢ç»è€…

- Zino Jeng

---

## License

MIT License
